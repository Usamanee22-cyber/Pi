<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTuber Body Tracker Pro</title>
    <!-- ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Library ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î -->
    <script src="https://cubism.live2d.com/sdk-web/bin/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.x/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background-color: #1a1a1a; overflow: hidden; font-family: 'Inter', sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; background: radial-gradient(circle, #ffafbd 0%, #ffc3a0 100%); display: flex; justify-content: center; align-items: center; }
        #video-container { position: absolute; bottom: 24px; right: 24px; width: 280px; height: 210px; border-radius: 20px; overflow: hidden; border: 4px solid #ffffff; box-shadow: 0 15px 35px rgba(0,0,0,0.3); z-index: 50; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: #000; }
        #video-container.fullscreen { width: 100vw; height: 100vh; bottom: 0; right: 0; border: none; border-radius: 0; }
        video, canvas.overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .ui-panel { position: absolute; top: 24px; left: 24px; z-index: 100; display: flex; flex-direction: column; gap: 12px; }
        .glass-btn { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 12px 24px; border-radius: 15px; cursor: pointer; font-weight: 600; transition: 0.3s; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .glass-btn:hover { background: rgba(255, 255, 255, 0.4); transform: translateY(-2px); }
        .status-badge { position: absolute; bottom: 24px; left: 24px; background: rgba(0,0,0,0.6); color: #fff; padding: 8px 16px; border-radius: 30px; font-size: 13px; backdrop-filter: blur(5px); display: flex; align-items: center; gap: 8px; }
        .dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; box-shadow: 0 0 10px #4ade80; }
        #loader { position: fixed; inset: 0; background: #ffafbd; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; transition: 0.8s; }
        .loader-icon { width: 80px; height: 80px; border: 6px solid #fff; border-top-color: #ff6b6b; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-icon"></div>
        <h2 class="mt-6 text-white text-xl font-bold tracking-wider">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI ‡πÅ‡∏•‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•...</h2>
        <p class="text-white/80 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 10-15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
    </div>

    <div class="ui-panel">
        <button class="glass-btn" onclick="setView('avatar')">‚ú® ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (Avatar)</button>
        <button class="glass-btn" onclick="setView('camera')">üîç ‡πÇ‡∏´‡∏°‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (Skeleton)</button>
    </div>

    <div id="canvas-container"></div>

    <div id="video-container">
        <video id="input-video" playsinline style="display:none"></video>
        <canvas id="output-canvas" class="overlay"></canvas>
    </div>

    <div class="status-badge">
        <div class="dot" id="status-dot"></div>
        <span id="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</span>
    </div>

    <script>
        const videoElement = document.getElementById('input-video');
        const canvasElement = document.getElementById('output-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const loader = document.getElementById('loader');

        let app, model, currentMode = 'avatar';

        function setView(mode) {
            currentMode = mode;
            const container = document.getElementById('video-container');
            if (mode === 'camera') {
                container.classList.add('fullscreen');
            } else {
                container.classList.remove('fullscreen');
            }
        }

        async function init() {
            // 1. Setup PixiJS
            app = new PIXI.Application({
                width: window.innerWidth,
                height: window.innerHeight,
                backgroundAlpha: 0,
                antialias: true
            });
            document.getElementById('canvas-container').appendChild(app.view);

            // 2. Load Model (‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
            const modelUrl = "https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/rice/rice.model3.json";
            
            try {
                model = await PIXI.live2d.Live2DModel.from(modelUrl);
                app.stage.addChild(model);
                
                // ‡∏à‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î
                const ratio = Math.min(window.innerWidth / model.width, window.innerHeight / model.height) * 0.7;
                model.scale.set(ratio);
                model.anchor.set(0.5, 0.5);
                model.x = window.innerWidth / 2;
                model.y = window.innerHeight / 2 + 50;

                // 3. Setup Holistic
                const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
                holistic.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: true,
                    refineFaceLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                holistic.onResults(onResults);

                // 4. Start Camera
                const camera = new Camera(videoElement, {
                    onFrame: async () => await holistic.send({image: videoElement}),
                    width: 640,
                    height: 480
                });

                await camera.start();
                
                // Success!
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 800);
                statusText.innerText = "‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)";
                statusDot.style.background = "#4ade80";

            } catch (err) {
                console.error(err);
                statusText.innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î";
                statusDot.style.background = "#f87171";
            }
        }

        function onResults(results) {
            if (canvasElement.width !== videoElement.videoWidth) {
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
            }

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            if (currentMode === 'camera') {
                canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
                drawConnectors(canvasCtx, results.poseLandmarks, HOLISTIC_CONNECTIONS, {color: '#ffffff', lineWidth: 2});
                drawLandmarks(canvasCtx, results.leftHandLandmarks, {color: '#ff6b6b', lineWidth: 1, radius: 2});
                drawLandmarks(canvasCtx, results.rightHandLandmarks, {color: '#4ade80', lineWidth: 1, radius: 2});
            }

            if (model && results.faceLandmarks) {
                const core = model.internalModel.coreModel;
                
                // Head movement
                const nose = results.faceLandmarks[1];
                core.setParameterValueById('ParamAngleX', (nose.x - 0.5) * -60);
                core.setParameterValueById('ParamAngleY', (nose.y - 0.5) * -60);
                
                // Eye Blinking
                const lEye = results.faceLandmarks[159].y - results.faceLandmarks[145].y;
                const rEye = results.faceLandmarks[386].y - results.faceLandmarks[374].y;
                core.setParameterValueById('ParamEyeLOpen', lEye > 0.012 ? 1 : 0);
                core.setParameterValueById('ParamEyeROpen', rEye > 0.012 ? 1 : 0);

                // Mouth
                const mY = Math.abs(results.faceLandmarks[13].y - results.faceLandmarks[14].y);
                core.setParameterValueById('ParamMouthOpenY', Math.min(mY * 20, 1));
            }
            canvasCtx.restore();
        }

        window.onload = init;
        window.onresize = () => {
            if (app) {
                app.renderer.resize(window.innerWidth, window.innerHeight);
                if (model) {
                    model.x = window.innerWidth / 2;
                    model.y = window.innerHeight / 2 + 50;
                }
            }
        };
    </script>
</body>
</html>

