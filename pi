<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Live2D VTuber System</title>
    <!-- Core Libraries -->
    <script src="https://cubism.live2d.com/sdk-web/bin/core/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/kalidokit@1.1/dist/kalidokit.bundle.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: radial-gradient(circle, #ffdee9 0%, #b5fffc 100%); overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; }
        .v-container { position: relative; }
        #webcam { transform: scaleX(-1); border-radius: 15px; border: 4px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body>

<div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
    <div class="text-4xl mb-4 animate-bounce">üéÄ</div>
    <h1 class="text-pink-500 font-bold text-2xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö VTuber ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°...</h1>
    <p class="text-gray-400 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• 5-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</p>
</div>

<div class="absolute top-5 left-5 z-10 flex gap-3">
    <button onclick="changePage('model')" id="btn-model" class="panel px-6 py-3 rounded-2xl font-bold text-pink-600 shadow-lg border-b-4 border-pink-400 active:translate-y-1 transition-all">üéÄ ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°</button>
    <button onclick="changePage('camera')" id="btn-camera" class="panel px-6 py-3 rounded-2xl font-bold text-blue-600 shadow-lg border-b-4 border-blue-400 active:translate-y-1 transition-all">üîç ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠</button>
</div>

<div class="v-container h-screen w-screen flex items-center justify-center">
    <!-- View 1: Live2D Character -->
    <canvas id="canvas" class="z-0"></canvas>
    
    <!-- View 2: Camera & Skeleton (Hidden initially) -->
    <div id="camera-view" class="hidden absolute inset-0 flex items-center justify-center bg-black/80">
        <div class="relative">
            <video id="webcam" width="800" height="600" autoplay playsinline></video>
            <canvas id="skeleton-canvas" class="absolute inset-0 w-full h-full"></canvas>
            <div class="absolute top-4 left-4 bg-black/50 text-white p-2 rounded text-xs">
                AI Tracking: 543 Points (Face/Pose/Hands)
            </div>
        </div>
    </div>
</div>

<script>
const videoElement = document.getElementById('webcam');
const skeletonCanvas = document.getElementById('skeleton-canvas');
const skeletonCtx = skeletonCanvas.getContext('2d');
let currentModel;
let app;

// --- 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô PixiJS & Live2D ---
async function init() {
    app = new PIXI.Application({
        view: document.getElementById('canvas'),
        autoStart: true,
        backgroundAlpha: 0,
        resizeTo: window,
        antialias: true
    });

    // ‡πÇ‡∏°‡πÄ‡∏î‡∏• Live2D ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á (Hiyori) ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö Physics ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏≤‡∏î‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
    const modelUrl = "https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/hiyori/hiyori_pro_t10.model3.json";
    
    currentModel = await PIXI.live2d.Live2DModel.from(modelUrl);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    const scale = Math.min(app.screen.width / currentModel.width, app.screen.height / currentModel.height) * 0.8;
    currentModel.scale.set(scale);
    currentModel.anchor.set(0.5, 0.5);
    currentModel.position.set(app.screen.width / 2, app.screen.height * 0.6);
    
    app.stage.addChild(currentModel);
    document.getElementById('loading').style.display = 'none';

    setupTracking();
}

// --- 2. ‡∏£‡∏∞‡∏ö‡∏ö AI Tracking ‡∏î‡πâ‡∏ß‡∏¢ MediaPipe Holistic ---
function setupTracking() {
    const holistic = new Holistic({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`
    });

    holistic.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7,
        refineFaceLandmarks: true
    });

    holistic.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await holistic.send({ image: videoElement });
        },
        width: 640,
        height: 480
    });
    camera.start();
}

// --- 3. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÇ‡∏°‡πÄ‡∏î‡∏• Live2D (Kalidokit) ---
function onResults(results) {
    // ‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Skeleton (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà)
    if (!document.getElementById('camera-view').classList.contains('hidden')) {
        drawSkeleton(results);
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏î‡πâ‡∏ß‡∏¢ Kalidokit
    const riggedPose = Kalidokit.Pose.solve(results.poseLandmarks, results.image);
    const riggedFace = Kalidokit.Face.solve(results.faceLandmarks);
    const riggedHandL = Kalidokit.Hand.solve(results.leftHandLandmarks, "Left");
    const riggedHandR = Kalidokit.Hand.solve(results.rightHandLandmarks, "Right");

    if (currentModel) {
        animateLive2D(riggedPose, riggedFace, riggedHandL, riggedHandR);
    }
}

function animateLive2D(pose, face, handL, handR) {
    const core = currentModel.internalModel.coreModel;
    
    // ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏Ñ‡∏≠ (XYZ)
    currentModel.internalModel.motionManager.update = () => {
        // Face Look
        currentModel.focusHandler.focus(face.head.x, face.head.y);
        
        // Face Expression
        core.setParameterValueById('ParamEyeLOpen', face.eye.l);
        core.setParameterValueById('ParamEyeROpen', face.eye.r);
        core.setParameterValueById('ParamMouthOpenY', face.mouth.y);
        core.setParameterValueById('ParamMouthSize', face.mouth.shape);
        
        // Brow
        core.setParameterValueById('ParamBrowLY', face.brow);
        core.setParameterValueById('ParamBrowRY', face.brow);

        // Body Sway
        core.setParameterValueById('ParamBodyAngleX', pose.worldPose.degrees.y);
        core.setParameterValueById('ParamBodyAngleY', pose.worldPose.degrees.x);
        core.setParameterValueById('ParamBodyAngleZ', pose.worldPose.degrees.z);
    };
}

function drawSkeleton(results) {
    skeletonCanvas.width = videoElement.width;
    skeletonCanvas.height = videoElement.height;
    skeletonCtx.clearRect(0, 0, skeletonCanvas.width, skeletonCanvas.height);
    
    // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠
    window.drawConnectors(skeletonCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
    window.drawLandmarks(skeletonCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2});
    window.drawConnectors(skeletonCtx, results.faceLandmarks, FACEMESH_TESSELATION, {color: '#C0C0C070', lineWidth: 1});
    window.drawConnectors(skeletonCtx, results.leftHandLandmarks, HAND_CONNECTIONS, {color: '#CC0000', lineWidth: 5});
    window.drawConnectors(skeletonCtx, results.rightHandLandmarks, HAND_CONNECTIONS, {color: '#00CC00', lineWidth: 5});
}

// --- 4. ‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
function changePage(page) {
    const cameraView = document.getElementById('camera-view');
    const canvas = document.getElementById('canvas');
    if (page === 'camera') {
        cameraView.classList.remove('hidden');
        canvas.classList.add('opacity-30');
    } else {
        cameraView.classList.add('hidden');
        canvas.classList.remove('opacity-30');
    }
}

window.onload = init;
</script>
</body>
</html>

